build_and_store_wheels: &BUILD_AND_STORE_WHEELS
  install_cibuildwheel_script:
    - python3 -m pip install cibuildwheel
  cibuildwheel_script:
    - cibuildwheel
  always:
    show_meson_log_script: cat build/meson-logs/meson-log.txt
  wheels_artifacts:
    path: "wheelhouse/*"


######################################################################
# Build macosx_arm64 natively
######################################################################

macosx_arm64_task:
  use_compute_credits: $CIRRUS_USER_COLLABORATOR == 'true'
  macos_instance:
    matrix:
      # - image: ghcr.io/cirruslabs/macos-monterey-xcode:latest
      - image: ghcr.io/cirruslabs/macos-sonoma-xcode:latest
  matrix:
    - env:
        CIRRUS_CLONE_SUBMODULES: true
        CIBW_BUILD: cp310-*
        # Specifying CIBW_ENVIRONMENT_MACOS overrides pyproject.toml, so include
        # all the settings from there, otherwise they're lost.
        CIBW_ENVIRONMENT_MACOS: >
          RUNNER_OS=macOS
          MACOSX_DEPLOYMENT_TARGET=14.0
          # SDKROOT needs to be set also here (see gfortran_utils.sh)
          #SDKROOT=/Applications/Xcode-15.0.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk
          SDKROOT=/Applications/Xcode-15.0.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX12.3.sdk
  env:
    PATH: /opt/homebrew/opt/python@3.10/bin:/usr/local/lib:/usr/local/include:$PATH
    CIBW_ARCHS: arm64

  build_script:
    - brew install python@3.10
    - ln -s python3 /opt/homebrew/opt/python@3.10/bin/python
    - which python3
    # needed for submodules
    - git submodule update --init
    # need to obtain all the tags so setup.py can determine FULLVERSION
    - git fetch origin
    - uname -m
    - python3 -c "import platform; print(platform.python_version()); print(platform.system()); print(platform.machine())"
    - clang --version
  <<: *BUILD_AND_STORE_WHEELS
